// üìå Prevent Duplicate Script Execution
if (window.quizLoaded) {
    console.warn("‚ö†Ô∏è Quiz.js already loaded ‚Äì Skipping duplicate execution.");
} else {
    window.quizLoaded = true;

    // üìå Quiz State Variables
    let quizQuestions = [];
    let currentQuestionIndex = 0;
    let userResponses = {};

    // üìå DOM Elements
    const introContainer = document.getElementById("intro-container");
    const quizContainer = document.getElementById("quiz-container");
    const questionText = document.getElementById("question-text");
    const optionsContainer = document.getElementById("options-container");
    const nextButton = document.getElementById("next-button");
    const backButton = document.getElementById("back-button");
    const startButton = document.getElementById("start-button");

    // üìå Confirm Script is Running
    console.log("‚úÖ quiz.js Loaded Successfully!");

    // üìå Load Quiz Data from JSON
    fetch('quiz_data.json')
        .then(response => response.json())
        .then(data => {
            console.log("‚úÖ JSON Loaded Successfully:", data);

            if (!data.sections || !data.sections.foundational_assessment) {
                console.error("‚ùå JSON Format Error: Sections missing.");
                return;
            }

            quizQuestions = data.sections.foundational_assessment.questions;
            console.log("üìå Extracted Questions:", quizQuestions);

            loadProgress(); 
        })
        .catch(error => console.error("‚ùå Error loading JSON:", error));

    // üìå Save Quiz Progress to Session Storage
    function saveProgress() {
        sessionStorage.setItem("quizProgress", JSON.stringify({ 
            currentQuestionIndex, 
            userResponses 
        }));
    }

    // üìå Load Quiz Progress from Session Storage
    function loadProgress() {
        const savedProgress = JSON.parse(sessionStorage.getItem("quizProgress"));
        if (savedProgress) {
            currentQuestionIndex = savedProgress.currentQuestionIndex || 0;
            userResponses = savedProgress.userResponses || {};
        }
    }

    // üìå Start Quiz (Shows First Question)
    function startQuiz() {
        console.log("üöÄ Start Button Clicked! Starting Quiz...");
        introContainer.style.display = "none"; // Hide intro screen
        quizContainer.style.display = "block"; // Show quiz container
        loadQuestion();
    }

    // üìå Load Question
    function loadQuestion() {
        console.log("üìå Loading Question Index:", currentQuestionIndex);

        if (quizQuestions.length === 0) {
            console.error("‚ùå No Questions Found in JSON!");
            return;
        }

        if (currentQuestionIndex >= quizQuestions.length) {
            calculateResults();
            return;
        }

        const currentQuestion = quizQuestions[currentQuestionIndex];
        console.log("üéØ Current Question:", currentQuestion);

        if (!currentQuestion) {
            console.error("‚ùå Current Question is Undefined! Check JSON format.");
            return;
        }

        questionText.innerText = currentQuestion.question_text;
        optionsContainer.innerHTML = "";

        currentQuestion.response_options.forEach((option, index) => {
            const button = document.createElement("button");
            button.innerText = option;
            button.classList.add("option-button");
            button.onclick = () => selectOption(index, currentQuestion.id, currentQuestion.weight);
            optionsContainer.appendChild(button);
        });

        backButton.style.display = currentQuestionIndex > 0 ? "block" : "none";
        nextButton.style.display = "none"; // Hide next button until an answer is chosen

        saveProgress();
    }

    // üìå Select Option
 function selectOption(index, questionId, weight) {
    console.log("üëâ Option Selected:", index, "for Question:", questionId, "Weight:", weight);

    // ‚úÖ Ensure userResponses exists
    if (!userResponses) {
        userResponses = {};
    }

    userResponses[questionId] = { selectedOption: index, weight: weight };
    console.log("üîÑ Updated User Responses:", userResponses);

    currentQuestionIndex++;
    console.log("‚û° Moving to Next Question. New Index:", currentQuestionIndex);

    saveProgress(); // ‚úÖ Save progress before moving forward
    loadQuestion();
}


    // üìå Back Button Functionality
    function goBack() {
        if (currentQuestionIndex > 0) {
            currentQuestionIndex--;
            loadQuestion();
        }
    }

   // üìå Calculate Results & Save to sessionStorage
function calculateResults() {
    console.log("üìä Calculating Results...");
    console.log("üîç User Responses:", userResponses);

    let archetypeScores = {};

    // ‚úÖ Process weighted scoring
    Object.entries(userResponses).forEach(([questionId, response]) => {
        let question = quizQuestions.find(q => q.id === questionId);
        if (question) {
            let archetype = question.archetype;
            let weight = response.weight || 1; // Default weight is 1 if missing
            archetypeScores[archetype] = (archetypeScores[archetype] || 0) + weight;
        } else {
            console.warn("‚ö†Ô∏è Question ID Not Found in Quiz Data:", questionId);
        }
    });

    let sortedArchetypes = Object.keys(archetypeScores).sort((a, b) => archetypeScores[b] - archetypeScores[a]);

    console.log("üèÜ Final Archetypes:", sortedArchetypes);

    // üö® If no valid archetypes found, redirect to quiz start
    if (sortedArchetypes.length === 0) {
        console.error("‚ùå No valid results found. Redirecting to quiz.");
        window.location.href = "index.html";
        return;
    }

    sessionStorage.setItem("quizResults", JSON.stringify(sortedArchetypes));
    console.log("‚úÖ Quiz Results Saved:", sessionStorage.getItem("quizResults"));

    window.location.href = "quiz_results.html";
}
    
    
    // ‚úÖ Save results to sessionStorage
    sessionStorage.setItem("quizResults", JSON.stringify(sortedArchetypes));
    window.location.href = "quiz_results.html"; // Redirect to results page
}


    // Process weighted scoring
    Object.entries(userResponses).forEach(([questionId, response]) => {
        let question = quizQuestions.find(q => q.id === questionId);
        if (question) {
            let archetype = question.archetype;
            let weight = response.weight || 1; // Default weight is 1 if missing
            archetypeScores[archetype] = (archetypeScores[archetype] || 0) + weight;
        } else {
            console.warn("‚ö†Ô∏è Question ID Not Found in Quiz Data:", questionId);
        }
    });

    let sortedArchetypes = Object.keys(archetypeScores).sort((a, b) => archetypeScores[b] - archetypeScores[a]);

    console.log("üèÜ Final Archetypes:", sortedArchetypes);

    // ‚úÖ FIX: Store final results properly before navigating
    sessionStorage.setItem("quizResults", JSON.stringify(sortedArchetypes));
    console.log("üíæ Results Saved:", sessionStorage.getItem("quizResults"));

    window.location.href = "quiz_results.html";
}

    // üìå Display Results
    function displayResults(sortedArchetypes) {
        sessionStorage.setItem("quizResults", JSON.stringify(sortedArchetypes));
        window.location.href = "quiz_results.html";
    }

    // üìå Event Listeners
  document.addEventListener("DOMContentLoaded", () => {
    console.log("üìå DOM Fully Loaded!");

    const startButton = document.getElementById("start-button");
    if (startButton) {
        console.log("üöÄ Start Button Found!");
        startButton.addEventListener("click", () => {
            console.log("üöÄ Start Button Clicked! Attempting to load first question...");
            document.getElementById("intro-container").style.display = "none"; // Hide Intro
            document.getElementById("quiz-container").style.display = "block"; // Show Quiz
            loadQuestion();
        });
    } else {
        console.error("‚ùå Start Button Not Found!");
    }
});

<script>
document.addEventListener("DOMContentLoaded", function() {
    console.log("üìå Results Page Loaded!");

    const primaryArchetypeElement = document.getElementById("primary-archetype");
    const secondaryArchetypeElement = document.getElementById("secondary-archetype");
    const archetypeDescriptionElement = document.getElementById("archetype-description");
    const affirmingMessageElement = document.getElementById("affirming-message");
    const personalizedInsightsElement = document.getElementById("personalized-insights");
    const reflectionListElement = document.getElementById("reflection-list");

    // üîç Retrieve saved results from sessionStorage
    const savedResults = sessionStorage.getItem("quizResults");

    if (!savedResults || savedResults === "undefined") {
        console.error("‚ùå Error: No quiz results found. Redirecting to quiz.");
        window.location.href = "index.html";
        return;
    }

    const archetypes = JSON.parse(savedResults);
    console.log("üèÜ Retrieved Quiz Results:", archetypes);

    if (!archetypes || archetypes.length === 0) {
        console.error("‚ö†Ô∏è No valid archetype found.");
        primaryArchetypeElement.innerText = "Error: No Results Found";
        return;
    }

    primaryArchetypeElement.innerText = archetypes[0] || "Unknown";
    secondaryArchetypeElement.innerText = archetypes[1] || "None";

    // ‚úÖ Fetch additional details based on the results
    fetch("quiz_data.json")
        .then(response => response.json())
        .then(data => {
            console.log("‚úÖ Archetype Data Loaded:", data.archetypes);
            const archetypeDetails = data.archetypes[archetypes[0]];

            if (archetypeDetails) {
                archetypeDescriptionElement.innerText = archetypeDetails.description || "No description available.";
                affirmingMessageElement.innerText = archetypeDetails.affirmation || "You are uniquely powerful!";
                personalizedInsightsElement.innerText = archetypeDetails.insights || "Explore your strengths!";

                // ‚úÖ Load Reflection Questions
                reflectionListElement.innerHTML = "";
                if (archetypeDetails.reflection) {
                    archetypeDetails.reflection.forEach(question => {
                        let li = document.createElement("li");
                        li.innerText = question;
                        reflectionListElement.appendChild(li);
                    });
                }
            } else {
                console.warn("‚ö†Ô∏è Archetype details not found in JSON.");
            }
        })
        .catch(error => console.error("‚ùå Error loading archetype details:", error));
});
</script>

